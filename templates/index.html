{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-calculator"></i> Calculate Staffing Requirements</h5>
            </div>
            <div class="card-body">
                {% if not age_groups %}
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    No age groups configured. <a href="{{ url_for('manage_age_groups') }}" class="alert-link">Add age groups first</a>
                    or <a href="{{ url_for('initialize_db') }}" class="alert-link">load sample data</a>.
                </div>
                {% else %}
                <form id="calculatorForm">
                    <div class="mb-3">
                        <h6>Enter Current Children Count by Age Group:</h6>
                    </div>
                    {% for group in age_groups %}
                    <div class="mb-3">
                        <label for="group_{{ group.id }}" class="form-label">
                            {{ group.name }}
                            <span class="badge bg-secondary">Ratio: {{ group.required_ratio }}</span>
                        </label>
                        <input type="number" class="form-control" id="group_{{ group.id }}"
                               name="group_{{ group.id }}" min="0" value="0" data-group-id="{{ group.id }}">
                    </div>
                    {% endfor %}

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-calculator"></i> Calculate Staffing Needs
                    </button>
                </form>
                {% endif %}
            </div>
        </div>

        <div id="resultsCard" class="card mt-4" style="display: none;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Staffing Analysis</h5>
            </div>
            <div class="card-body">
                <div id="resultsContent"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-person-badge"></i> Available Staff</h5>
            </div>
            <div class="card-body">
                {% if not staff %}
                <div class="alert alert-info mb-0">
                    <i class="bi bi-info-circle"></i>
                    No staff members configured. <a href="{{ url_for('manage_staff') }}" class="alert-link">Add staff members</a>.
                </div>
                {% else %}
                <div class="list-group list-group-flush">
                    {% for member in staff %}
                    <div class="list-group-item px-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ member.name }}</strong><br>
                                <small class="text-muted">{{ member.permit_level }}</small>
                            </div>
                            <span class="badge {% if member.is_available %}bg-success{% else %}bg-secondary{% endif %}">
                                {% if member.is_available %}Available{% else %}Unavailable{% endif %}
                            </span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Permit Levels</h6>
            </div>
            <div class="card-body small">
                <ul class="list-unstyled mb-0">
                    <li><strong>Program Director:</strong> Can supervise all staff</li>
                    <li><strong>Site Supervisor:</strong> Can supervise site operations</li>
                    <li><strong>Master Teacher:</strong> Curriculum coordinator</li>
                    <li><strong>Teacher:</strong> Lead classroom instruction</li>
                    <li><strong>Associate Teacher:</strong> Provide instruction</li>
                    <li><strong>Assistant:</strong> Must work under supervision</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('calculatorForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    const ageGroups = [];

    for (let [key, value] of formData.entries()) {
        const groupId = document.getElementById(key).dataset.groupId;
        const childCount = parseInt(value) || 0;
        if (childCount > 0) {
            ageGroups.push({
                age_group_id: parseInt(groupId),
                child_count: childCount
            });
        }
    }

    if (ageGroups.length === 0) {
        alert('Please enter at least one child count greater than 0.');
        return;
    }

    try {
        const response = await fetch('/calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ age_groups: ageGroups })
        });

        const results = await response.json();
        displayResults(results);
    } catch (error) {
        console.error('Error calculating staffing:', error);
        alert('Error calculating staffing requirements. Please try again.');
    }
});

function displayResults(results) {
    const resultsCard = document.getElementById('resultsCard');
    const resultsContent = document.getElementById('resultsContent');

    let html = '<h6>Staffing Requirements by Age Group:</h6>';
    html += '<table class="table table-sm">';
    html += '<thead><tr><th>Age Group</th><th>Children</th><th>Ratio Used</th><th>Staff Needed</th></tr></thead>';
    html += '<tbody>';

    results.age_groups.forEach(group => {
        let ratioCell = group.ratio;
        if (group.ratio_used === 'enhanced') {
            ratioCell += ' <span class="badge bg-success">Enhanced</span>';
            if (group.enhanced_description) {
                ratioCell += `<br><small class="text-muted">${group.enhanced_description}</small>`;
            }
        }

        html += `<tr>
            <td>${group.name}</td>
            <td>${group.children}</td>
            <td>${ratioCell}</td>
            <td><strong>${group.staff_needed}</strong></td>
        </tr>`;

        // Show available enhanced options
        if (group.enhanced_options && group.enhanced_options.length > 0) {
            group.enhanced_options.forEach(option => {
                if (!option.can_use && group.ratio_used === 'basic') {
                    html += `<tr class="table-warning">
                        <td colspan="4" class="small">
                            <i class="bi bi-info-circle"></i>
                            <strong>Could use ${option.ratio}</strong> (${option.description}) if: ${option.reason}
                        </td>
                    </tr>`;
                }
            });
        }
    });

    html += '</tbody></table>';

    // Show qualification warnings
    if (results.qualification_warnings && results.qualification_warnings.length > 0) {
        html += '<div class="alert alert-danger mt-3">';
        html += '<h6><i class="bi bi-exclamation-triangle"></i> Qualification Warnings</h6>';
        html += '<ul class="mb-0">';
        results.qualification_warnings.forEach(warning => {
            html += `<li>${warning}</li>`;
        });
        html += '</ul></div>';
    }

    html += '<div class="alert ' + (results.is_adequately_staffed ? 'alert-success' : 'alert-warning') + ' mt-3">';
    html += '<h6><i class="bi bi-' + (results.is_adequately_staffed ? 'check-circle' : 'exclamation-triangle') + '"></i> Summary</h6>';
    html += `<p class="mb-1"><strong>Total Staff Required:</strong> ${results.total_staff_needed}</p>`;

    const totalAvailable = Object.values(results.available_staff).reduce((sum, arr) => sum + arr.length, 0);
    html += `<p class="mb-1"><strong>Available Staff:</strong> ${totalAvailable}</p>`;

    if (results.is_adequately_staffed) {
        html += '<p class="mb-0 text-success"><i class="bi bi-check-circle"></i> You have adequate staffing!</p>';
    } else {
        const shortage = results.total_staff_needed - totalAvailable;
        html += `<p class="mb-0 text-warning"><i class="bi bi-exclamation-triangle"></i> You need ${shortage} more staff member(s).</p>`;
    }

    html += '</div>';

    // Show director info
    if (results.director_info && results.director_info.name) {
        const directorClass = results.director_info.counts_toward_ratio ? 'alert-success' : 'alert-warning';
        html += `<div class="alert ${directorClass} mt-2">`;
        html += `<strong><i class="bi bi-person-badge"></i> Director:</strong> ${results.director_info.name} (${results.director_info.level})<br>`;
        html += `<small>${results.director_info.status}</small>`;
        html += '</div>';
    }

    // Show supervisor capacity details
    if (results.supervisor_capacity && results.supervisor_capacity.max_assistants > 0) {
        html += '<div class="alert alert-info mt-2">';
        html += '<strong><i class="bi bi-diagram-3"></i> Supervisor Capacity:</strong><br>';
        html += `Can supervise up to <strong>${results.supervisor_capacity.max_assistants} assistants</strong> simultaneously<br>`;
        if (results.supervisor_capacity.breakdown) {
            html += '<small class="mt-1 d-block">Breakdown: ';
            const breakdown = Object.entries(results.supervisor_capacity.breakdown)
                .map(([level, info]) => `${info.count} ${level} (${info.capacity} capacity)`)
                .join(', ');
            html += breakdown + '</small>';
        }
        html += '</div>';
    }

    // Show cost analysis
    if (results.cost_analysis) {
        const cost = results.cost_analysis;
        html += '<div class="alert alert-primary mt-3">';
        html += '<h6><i class="bi bi-currency-dollar"></i> Cost Analysis</h6>';
        html += `<div class="row">
            <div class="col-md-6">
                <p class="mb-1"><strong>Total Hourly Cost:</strong> $${cost.total_hourly_cost.toFixed(2)}/hr</p>
                <p class="mb-1"><strong>Average Rate:</strong> $${cost.average_hourly_rate.toFixed(2)}/hr</p>
                <p class="mb-1"><strong>Daily (8 hrs):</strong> $${cost.daily_cost_8hr.toFixed(2)}</p>
            </div>
            <div class="col-md-6">
                <p class="mb-1"><strong>Weekly (40 hrs):</strong> $${cost.weekly_cost_40hr.toFixed(2)}</p>
                <p class="mb-1"><strong>Monthly (160 hrs):</strong> $${cost.monthly_cost_160hr.toFixed(2)}</p>
                <p class="mb-1"><strong>Annual (2080 hrs):</strong> $${cost.annual_cost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
            </div>
        </div>`;
        html += '</div>';
    }

    if (Object.keys(results.available_staff).length > 0) {
        html += '<h6 class="mt-3">Available Staff by Permit Level:</h6>';
        html += '<ul class="list-group">';

        const sortedLevels = ['Program Director', 'Site Supervisor', 'Master Teacher', 'Teacher', 'Associate Teacher', 'Assistant'];
        sortedLevels.forEach(level => {
            if (results.available_staff[level] && results.available_staff[level].length > 0) {
                const staff = results.available_staff[level];
                let staffInfo = `${staff.length} available`;

                // Show ECE units for Assistants
                if (level === 'Assistant') {
                    const withECE = staff.filter(s => s.ece_units >= 6);
                    if (withECE.length > 0) {
                        staffInfo += ` <span class="badge bg-info">${withECE.length} with 6+ ECE units</span>`;
                    }
                }

                // Show total hourly cost for this level
                const levelHourlyCost = staff.reduce((sum, s) => sum + s.hourly_rate, 0);
                if (levelHourlyCost > 0) {
                    staffInfo += ` <span class="badge bg-secondary">$${levelHourlyCost.toFixed(2)}/hr total</span>`;
                }

                html += `<li class="list-group-item">
                    <strong>${level}:</strong> ${staffInfo}
                </li>`;
            }
        });

        html += '</ul>';
    }

    // Show staff assignment suggestions
    if (results.suggested_assignments && results.suggested_assignments.assignments.length > 0) {
        html += '<h6 class="mt-3">Suggested Staff Assignments:</h6>';
        results.suggested_assignments.assignments.forEach(assignment => {
            html += '<div class="card mb-2">';
            html += '<div class="card-body p-2">';
            html += `<strong>${assignment.age_group}</strong> (${assignment.children} children)<br>`;

            if (assignment.warnings && assignment.warnings.length > 0) {
                html += '<div class="alert alert-warning mb-1 mt-1 py-1"><small>';
                assignment.warnings.forEach(w => html += `${w}<br>`);
                html += '</small></div>';
            }

            if (assignment.suggested_staff && assignment.suggested_staff.length > 0) {
                html += '<small class="text-muted">Suggested: ';
                html += assignment.suggested_staff
                    .map(s => `${s.name} (${s.level})`)
                    .join(', ');
                html += '</small>';
            } else {
                html += '<small class="text-muted">No qualified staff available</small>';
            }

            html += '</div></div>';
        });
    }

    resultsContent.innerHTML = html;
    resultsCard.style.display = 'block';
    resultsCard.scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}
