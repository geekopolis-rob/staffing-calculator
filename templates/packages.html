{% extends "base.html" %}

{% block title %}Enrollment Packages - Staffing Calculator{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <h2><i class="bi bi-box-seam"></i> Enrollment Packages</h2>
        <p class="text-muted">Manage saved pricing packages for enrollment</p>
    </div>
    <div class="col-auto">
        <a href="{{ url_for('pricing_calculator') }}" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Create from Calculator
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        {% if not packages %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No packages saved yet. Use the pricing calculator to create and save packages.
        </div>
        {% else %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Package Name</th>
                        <th>Core Plan</th>
                        <th>Extended Care</th>
                        <th>Monthly Tuition</th>
                        <th>Age Group</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for package in packages %}
                    <tr>
                        <td>
                            <strong>{{ package.name }}</strong>
                            {% if package.description %}
                            <br><small class="text-muted">{{ package.description }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {{ package.core_plan.name }}<br>
                            <small class="text-muted">{{ package.core_plan.get_schedule_display() }}</small>
                        </td>
                        <td>
                            {% if package.extended_care_start_time and package.extended_care_end_time %}
                            <span class="badge bg-info">
                                {{ package.extended_care_start_time }} - {{ package.extended_care_end_time }}
                            </span>
                            {% else %}
                            <span class="text-muted">â€”</span>
                            {% endif %}
                        </td>
                        <td>
                            <strong>${{ "%.2f"|format(package.monthly_tuition) }}</strong>/month
                        </td>
                        <td>
                            {% if package.age_group %}
                            <small>{{ package.age_group.name }}</small>
                            {% else %}
                            <small class="text-muted">All ages</small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge {% if package.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                {{ 'Active' if package.is_active else 'Inactive' }}
                            </span>
                        </td>
                        <td>
                            <button type="button" class="btn btn-sm btn-info"
                                    data-bs-toggle="modal" data-bs-target="#viewPackageModal{{ package.id }}"
                                    title="View Details">
                                <i class="bi bi-eye"></i>
                            </button>
                            <form method="POST" action="{{ url_for('toggle_package', id=package.id) }}" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-warning" title="Toggle Active">
                                    <i class="bi bi-toggle-{{ 'on' if package.is_active else 'off' }}"></i>
                                </button>
                            </form>
                            <form method="POST" action="{{ url_for('delete_package', id=package.id) }}" style="display: inline;">
                                <button type="submit" class="btn btn-sm btn-danger"
                                        onclick="return confirm('Delete {{ package.name }}?')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- View Package Detail Modals -->
        {% for package in packages %}
        <div class="modal fade" id="viewPackageModal{{ package.id }}" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="bi bi-box-seam"></i> {{ package.name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        {% if package.description %}
                        <p class="text-muted">{{ package.description }}</p>
                        {% endif %}

                        <h6 class="border-bottom pb-2">Core Plan</h6>
                        <div class="mb-3">
                            <strong>{{ package.core_plan.name }}</strong><br>
                            <small>{{ package.core_plan.get_schedule_display() }}</small><br>
                            <span class="text-success">${{ "%.2f"|format(package.core_plan.base_price) }}/{{ package.core_plan.billing_period }}</span>
                        </div>

                        {% if package.extended_care_start_time and package.extended_care_end_time %}
                        <h6 class="border-bottom pb-2">Extended Care</h6>
                        <div class="mb-3">
                            {{ package.extended_care_start_time }} - {{ package.extended_care_end_time }}
                        </div>
                        {% endif %}

                        {% if package.package_addons %}
                        <h6 class="border-bottom pb-2">Add-Ons</h6>
                        <ul class="list-unstyled mb-3">
                            {% for pa in package.package_addons %}
                            <li>
                                <i class="bi bi-check-circle text-success"></i>
                                {{ pa.addon.name }}
                                {% if pa.addon.pricing_type == 'per_day' %}
                                ({{ pa.quantity }} days/week)
                                {% elif pa.addon.pricing_type == 'time_based' %}
                                ({{ pa.quantity }} minutes)
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}

                        {% if package.package_fees %}
                        <h6 class="border-bottom pb-2">One-Time Fees</h6>
                        <ul class="list-unstyled mb-3">
                            {% for pf in package.package_fees %}
                            <li>
                                <i class="bi bi-receipt text-warning"></i>
                                {{ pf.fee.name }} - ${{ "%.2f"|format(pf.fee.amount) }}
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}

                        {% if package.package_discounts %}
                        <h6 class="border-bottom pb-2">Discounts</h6>
                        <ul class="list-unstyled mb-3">
                            {% for pd in package.package_discounts %}
                            <li>
                                <i class="bi bi-percent text-danger"></i>
                                {{ pd.discount.name }}
                                {% if pd.discount.discount_type == 'percentage' %}
                                ({{ pd.discount.amount }}%)
                                {% else %}
                                (${{ "%.2f"|format(pd.discount.amount) }})
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                        {% endif %}

                        <div class="alert alert-success mt-3">
                            <strong>Monthly Tuition:</strong> ${{ "%.2f"|format(package.monthly_tuition) }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        {% endif %}
    </div>
</div>
{% endblock %}
