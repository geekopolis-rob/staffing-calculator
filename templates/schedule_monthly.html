{% extends "base.html" %}

{% block title %}Schedule Planning - Staffing Calculator{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <h2><i class="bi bi-calendar-week"></i> Weekly Schedule</h2>
        <p class="text-muted">Weekly schedule based on enrollment mix (for planning purposes)</p>
    </div>
</div>

<!-- Weekly Labor Summary -->
<div class="card mb-4">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0"><i class="bi bi-currency-dollar"></i> Weekly Labor Summary</h5>
    </div>
    <div class="card-body">
        <div class="row text-center mb-3">
            <div class="col">
                <div class="border rounded p-2">
                    <h4 class="text-primary mb-0">{{ weekly_labor.total_positions }}</h4>
                    <small class="text-muted">Positions/Day</small>
                </div>
            </div>
            <div class="col">
                <div class="border rounded p-2">
                    <h4 class="text-success mb-0">${{ "%.2f"|format(weekly_labor.daily_cost) }}</h4>
                    <small class="text-muted">Daily Cost</small>
                </div>
            </div>
            <div class="col">
                <div class="border rounded p-2">
                    <h4 class="text-success mb-0">${{ "%.2f"|format(weekly_labor.weekly_cost) }}</h4>
                    <small class="text-muted">Weekly Cost</small>
                </div>
            </div>
            <div class="col">
                <div class="border rounded p-2">
                    <h4 class="text-info mb-0">${{ "%.2f"|format(weekly_labor.monthly_cost) }}</h4>
                    <small class="text-muted">Monthly Cost</small>
                </div>
            </div>
        </div>

        <!-- Shift Breakdown -->
        <h6 class="mb-2">Shift Breakdown (Peak Day Staffing)</h6>
        <table class="table table-sm mb-0">
            <thead>
                <tr>
                    <th>Shift</th>
                    <th>Schedule</th>
                    <th class="text-center">Staff</th>
                    <th class="text-center">Hours</th>
                </tr>
            </thead>
            <tbody>
                {% if weekly_labor.core_staff > 0 %}
                <tr>
                    <td>Core Hours</td>
                    <td><small>8:30am - 3:30pm</small></td>
                    <td class="text-center">{{ weekly_labor.core_staff }}</td>
                    <td class="text-center">{{ weekly_labor.core_hours }}</td>
                </tr>
                {% endif %}
                {% if weekly_labor.extended_staff > 0 %}
                <tr>
                    <td>Extended AM</td>
                    <td><small>7:00am - 1:00pm</small></td>
                    <td class="text-center">{{ weekly_labor.extended_staff }}</td>
                    <td class="text-center">{{ weekly_labor.extended_am_hours }}</td>
                </tr>
                <tr>
                    <td>Extended PM</td>
                    <td><small>12:30pm - 6:00pm</small></td>
                    <td class="text-center">{{ weekly_labor.extended_staff }}</td>
                    <td class="text-center">{{ weekly_labor.extended_pm_hours }}</td>
                </tr>
                {% endif %}
            </tbody>
            <tfoot>
                <tr class="table-light">
                    <td colspan="2"><strong>Total</strong></td>
                    <td class="text-center"><strong>{{ weekly_labor.total_positions }}</strong></td>
                    <td class="text-center"><strong>{{ weekly_labor.total_hours }} hrs</strong></td>
                </tr>
            </tfoot>
        </table>
        <small class="text-muted">Avg hourly rate: ${{ weekly_labor.avg_rate }}/hr | Extended hours split into 2 shifts to avoid overtime</small>

        <hr class="my-3">

        <!-- Enrollment Breakdown -->
        <h6 class="mb-2">Enrollment Breakdown</h6>
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
                    <span><strong>Infants</strong> <small class="text-muted">(0-18 months)</small></span>
                    <span>
                        <span class="badge bg-warning text-dark">{{ capacity_data.schedule_summary.core.infants }} Core</span>
                        <span class="badge bg-danger">{{ capacity_data.schedule_summary.extended.infants }} Extended</span>
                        <strong class="ms-2">{{ capacity_data.schedule_summary.core.infants + capacity_data.schedule_summary.extended.infants }} total</strong>
                    </span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2">
                    <span><strong>Children</strong> <small class="text-muted">(2+ years)</small></span>
                    <span>
                        <span class="badge bg-info">{{ capacity_data.schedule_summary.core.children }} Core</span>
                        <span class="badge bg-success">{{ capacity_data.schedule_summary.extended.children }} Extended</span>
                        <strong class="ms-2">{{ capacity_data.schedule_summary.core.children + capacity_data.schedule_summary.extended.children }} total</strong>
                    </span>
                </div>
            </div>
        </div>

        <!-- Daily Attendance -->
        <h6 class="mb-2">Daily Attendance</h6>
        <div class="row text-center mb-3">
            {% for day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'] %}
            <div class="col">
                <div class="border rounded p-2">
                    <small class="text-muted d-block">{{ day[:3] }}</small>
                    <strong>{{ schedule_data[day].total_children }}</strong>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Staff Ratios -->
        <div class="d-flex align-items-center">
            <strong class="me-2">Staff Ratios:</strong>
            <span class="badge bg-warning text-dark me-2">1:4 Infants</span>
            <span class="badge bg-info">1:12 Children</span>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body p-0">
        {% for day_name in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'] %}
        {% set day = schedule_data[day_name] %}
        <div class="border-bottom">
            <!-- Clickable header -->
            <div class="d-flex align-items-center p-3"
                 style="cursor: pointer;"
                 data-bs-toggle="collapse"
                 data-bs-target="#detail-{{ day_name }}"
                 onmouseover="this.style.backgroundColor='#f8f9fa'"
                 onmouseout="this.style.backgroundColor=''">

                <!-- Day label -->
                <div style="width: 80px;">
                    <strong>{{ day_name[:3] }}</strong>
                    <small class="d-block text-muted">{{ day.total_children }} kids</small>
                </div>

                <!-- Mini timeline -->
                <div class="flex-grow-1 mx-3">
                    {% set timeline = day.timeline %}
                    {% set total_minutes = timeline.latest - timeline.earliest %}
                    {% set max_students = timeline.max_students if timeline.max_students > 0 else 1 %}
                    {% set max_staff = timeline.max_staff if timeline.max_staff > 0 else 1 %}
                    <!-- Time labels -->
                    <div class="d-flex justify-content-between" style="font-size: 0.65rem; color: #999; margin-left: 32px;">
                        <span>7am</span><span>9</span><span>12pm</span><span>3</span><span>6pm</span>
                    </div>
                    <!-- Kids bar -->
                    <div class="d-flex align-items-center" style="margin-bottom: 4px;">
                        <span style="width: 30px; font-size: 0.65rem; color: #666;">Kids</span>
                        <div class="position-relative flex-grow-1" style="height: 12px; background: #e9ecef; border-radius: 2px;">
                            {% for interval in timeline.intervals %}
                            {% if interval.students > 0 %}
                            {% set left_pct = ((interval.time - timeline.earliest) / total_minutes * 100)|round(1) %}
                            {% set width_pct = (15 / total_minutes * 100)|round(1) %}
                            {% set opacity = (0.3 + 0.7 * (interval.students / max_students))|round(2) %}
                            <div style="position: absolute; left: {{ left_pct }}%; width: {{ width_pct }}%; height: 100%; background: rgba(13, 110, 253, {{ opacity }});"></div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <!-- Staff bar -->
                    <div class="d-flex align-items-center">
                        <span style="width: 30px; font-size: 0.65rem; color: #666;">Staff</span>
                        <div class="position-relative flex-grow-1" style="height: 12px; background: #e9ecef; border-radius: 2px;">
                            {% for interval in timeline.intervals %}
                            {% if interval.staff > 0 or interval.students > 0 %}
                            {% set left_pct = ((interval.time - timeline.earliest) / total_minutes * 100)|round(1) %}
                            {% set width_pct = (15 / total_minutes * 100)|round(1) %}
                            {% set opacity = (0.3 + 0.7 * (interval.staff / max_staff))|round(2) if interval.staff > 0 else 1 %}
                            {% if interval.students > 0 and interval.staff == 0 %}
                            <div style="position: absolute; left: {{ left_pct }}%; width: {{ width_pct }}%; height: 100%; background: #ffc107;"></div>
                            {% elif interval.students > 0 and interval.staff > 0 %}
                            <div style="position: absolute; left: {{ left_pct }}%; width: {{ width_pct }}%; height: 100%; background: rgba(25, 135, 84, {{ opacity }});"></div>
                            {% elif interval.staff > 0 %}
                            <div style="position: absolute; left: {{ left_pct }}%; width: {{ width_pct }}%; height: 100%; background: rgba(111, 66, 193, {{ opacity }});"></div>
                            {% endif %}
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Toggle chevron -->
                <i class="bi bi-chevron-down text-muted"></i>
            </div>

            <!-- Collapsible detail section -->
            <div class="collapse" id="detail-{{ day_name }}">
                <div class="px-3 pb-3">
                    <!-- Summary stats -->
                    <div class="d-flex gap-4 mb-2 small text-muted">
                        <span>{{ day.labor.total_positions }} staff</span>
                        <span>${{ "%.0f"|format(day.labor.daily_cost) }}/day</span>
                    </div>

                    <!-- Detailed timeline -->
                    <div class="position-relative bg-light rounded p-2" style="margin-left: 50px;">
                        {% set earliest = 420 %}
                        {% set latest = 1080 %}
                        {% set total_mins = latest - earliest %}

                        <!-- Time markers -->
                        <div class="d-flex justify-content-between mb-1" style="font-size: 0.65rem; color: #999;">
                            <span>7am</span><span>9</span><span>12pm</span><span>3</span><span>6pm</span>
                        </div>

                        <!-- Enrollment bars -->
                        {% for enr in day.children_detail %}
                        {% set left = ((enr.start_minutes - earliest) / total_mins * 100)|round(1) %}
                        {% set width = ((enr.end_minutes - enr.start_minutes) / total_mins * 100)|round(1) %}
                        {% if enr.age_group_type == 'infant' %}
                            {% set color = '#ffc107' if enr.schedule_type == 'core' else '#dc3545' %}
                        {% else %}
                            {% set color = '#0dcaf0' if enr.schedule_type == 'core' else '#198754' %}
                        {% endif %}
                        <div class="position-relative" style="height: 24px; margin-bottom: 4px;">
                            <div style="position: absolute; left: {{ left }}%; width: {{ width }}%; height: 100%; background: {{ color }}; border-radius: 3px; padding: 2px 6px; font-size: 0.7rem; color: {% if color in ['#ffc107', '#0dcaf0'] %}#212529{% else %}white{% endif %}; overflow: hidden; white-space: nowrap;">
                                <strong>{{ enr.count }}</strong> {{ enr.age_group }} {{ enr.schedule_type|title }}
                            </div>
                        </div>
                        {% endfor %}

                        <!-- Divider -->
                        <div style="border-top: 1px dashed #999; margin: 8px 0;"></div>

                        <!-- Staff bars -->
                        {% for shift in day.staff_shifts %}
                        {% set left = ((shift.start_minutes - earliest) / total_mins * 100)|round(1) %}
                        {% set width = ((shift.end_minutes - shift.start_minutes) / total_mins * 100)|round(1) %}
                        {% if shift.shift_type == 'core' %}{% set color = '#6f42c1' %}
                        {% elif shift.shift_type == 'extended_am' %}{% set color = '#d63384' %}
                        {% else %}{% set color = '#fd7e14' %}{% endif %}
                        <div class="position-relative" style="height: 24px; margin-bottom: 4px;">
                            <div style="position: absolute; left: {{ left }}%; width: {{ width }}%; height: 100%; background: {{ color }}; border-radius: 3px; padding: 2px 6px; font-size: 0.7rem; color: white; overflow: hidden; white-space: nowrap;">
                                {{ shift.label }}
                            </div>
                        </div>
                        {% endfor %}

                        <!-- Legend -->
                        <div class="d-flex flex-wrap gap-2 mt-2" style="font-size: 0.6rem; color: #666;">
                            <span><span style="display: inline-block; width: 10px; height: 10px; background: #ffc107; border-radius: 2px;"></span> Infant Core</span>
                            <span><span style="display: inline-block; width: 10px; height: 10px; background: #dc3545; border-radius: 2px;"></span> Infant Extended</span>
                            <span><span style="display: inline-block; width: 10px; height: 10px; background: #0dcaf0; border-radius: 2px;"></span> Child Core</span>
                            <span><span style="display: inline-block; width: 10px; height: 10px; background: #198754; border-radius: 2px;"></span> Child Extended</span>
                            <span class="ms-2"><span style="display: inline-block; width: 10px; height: 10px; background: #6f42c1; border-radius: 2px;"></span> Core Staff</span>
                            <span><span style="display: inline-block; width: 10px; height: 10px; background: #d63384; border-radius: 2px;"></span> Extended AM</span>
                            <span><span style="display: inline-block; width: 10px; height: 10px; background: #fd7e14; border-radius: 2px;"></span> Extended PM</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% endblock %}
