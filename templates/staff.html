{% extends "base.html" %}

{% block title %}Manage Staff - Staffing Calculator{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-person-badge"></i> Staff Members</h5>
                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addStaffModal">
                    <i class="bi bi-plus-circle"></i> Add Staff Member
                </button>
            </div>
            <div class="card-body">
                {% if not staff %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    No staff members configured yet. Click "Add Staff Member" to create your first entry.
                </div>
                {% else %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Permit Level</th>
                                <th>Hourly Rate</th>
                                <th>Qualifications</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for member in staff %}
                            <tr>
                                <td><strong>{{ member.name }}</strong></td>
                                <td>{{ member.permit_level }}</td>
                                <td>{{ member.hourly_rate|accounting }}/hr</td>
                                <td>
                                    <div class="small">
                                        {% if member.ece_units > 0 %}
                                        <span class="badge bg-info">{{ member.ece_units }} ECE units</span>
                                        {% endif %}
                                        {% if member.has_infant_specialization %}
                                        <span class="badge bg-success">Infant qualified</span>
                                        {% endif %}
                                        {% if not member.is_fully_qualified %}
                                        <span class="badge bg-warning">In training</span>
                                        {% endif %}
                                        {% if member.ece_units == 0 and not member.has_infant_specialization and member.is_fully_qualified %}
                                        <span class="text-muted">â€”</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if member.is_director %}
                                    <span class="badge bg-primary">Director</span><br>
                                    <small class="text-muted">{{ 'Teaching' if member.director_counts_toward_ratio else 'Admin only' }}</small>
                                    {% else %}
                                    <span class="text-muted small">Staff</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge {% if member.is_available %}bg-success{% else %}bg-secondary{% endif %}">
                                        {% if member.is_available %}
                                        <i class="bi bi-check-circle"></i> Available
                                        {% else %}
                                        <i class="bi bi-x-circle"></i> Unavailable
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    <form method="POST" action="{{ url_for('toggle_staff_availability', id=member.id) }}" style="display: inline;">
                                        <button type="submit" class="btn btn-sm {% if member.is_available %}btn-warning{% else %}btn-success{% endif %}"
                                                title="{% if member.is_available %}Mark Unavailable{% else %}Mark Available{% endif %}">
                                            <i class="bi bi-{% if member.is_available %}toggle-on{% else %}toggle-off{% endif %}"></i>
                                        </button>
                                    </form>
                                    <form method="POST" action="{{ url_for('delete_staff', id=member.id) }}" style="display: inline;">
                                        <button type="submit" class="btn btn-sm btn-danger"
                                                onclick="return confirm('Are you sure you want to delete {{ member.name }}?')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="mt-3">
                    <h6>Staff Summary:</h6>
                    <div class="row">
                        {% set staff_counts = {} %}
                        {% for member in staff %}
                            {% if member.is_available %}
                                {% set _ = staff_counts.update({member.permit_level: staff_counts.get(member.permit_level, 0) + 1}) %}
                            {% endif %}
                        {% endfor %}
                        {% for level in permit_levels %}
                        <div class="col-md-4 col-sm-6 mb-2">
                            <div class="card">
                                <div class="card-body py-2">
                                    <small class="text-muted">{{ level }}</small><br>
                                    <strong class="h5 mb-0">{{ staff_counts.get(level, 0) }}</strong>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Permit Levels</h6>
            </div>
            <div class="card-body small">
                <p><strong>Program Director</strong></p>
                <ul class="mb-2">
                    <li>Supervise single or multiple sites</li>
                    <li>Can supervise all other permit levels</li>
                </ul>

                <p><strong>Site Supervisor</strong></p>
                <ul class="mb-2">
                    <li>Supervise single site operations</li>
                    <li>Can supervise Master Teacher and below</li>
                </ul>

                <p><strong>Master Teacher</strong></p>
                <ul class="mb-2">
                    <li>Coordinate curriculum and staff development</li>
                    <li>Can supervise Teacher and below</li>
                </ul>

                <p><strong>Teacher</strong></p>
                <ul class="mb-2">
                    <li>Provide care, development, and instruction</li>
                    <li>Can supervise Associate Teacher and Assistant</li>
                </ul>

                <p><strong>Associate Teacher</strong></p>
                <ul class="mb-2">
                    <li>Provide care, development, and instruction</li>
                    <li>Can supervise Assistant only</li>
                </ul>

                <p><strong>Assistant</strong></p>
                <ul class="mb-0">
                    <li>Assist in care and instruction</li>
                    <li>Must work under supervision</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Add Staff Modal -->
<div class="modal fade" id="addStaffModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Add Staff Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_staff') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="name" class="form-label">Staff Member Name</label>
                        <input type="text" class="form-control" id="name" name="name"
                               required placeholder="e.g., Jane Smith">
                    </div>
                    <div class="mb-3">
                        <label for="permit_level" class="form-label">Permit Level</label>
                        <select class="form-select" id="permit_level" name="permit_level" required>
                            <option value="">Select permit level...</option>
                            {% for level in permit_levels %}
                            <option value="{{ level }}">{{ level }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="hourly_rate" class="form-label">Hourly Rate ($)</label>
                        <input type="number" class="form-control" id="hourly_rate" name="hourly_rate"
                               min="0" step="0.01" value="0" placeholder="20.00" required>
                        <div class="form-text">Staff member's hourly wage</div>
                    </div>
                    <div class="mb-3">
                        <label for="ece_units" class="form-label">ECE/CD Units Completed</label>
                        <input type="number" class="form-control" id="ece_units" name="ece_units"
                               min="0" max="100" value="12" placeholder="12">
                        <div class="form-text">Required for enhanced ratios (e.g., 6 units for 1:18 preschool ratio)</div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_fully_qualified"
                                   name="is_fully_qualified" checked>
                            <label class="form-check-label" for="is_fully_qualified">
                                Fully Qualified (12 ECE units + 6 months experience)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="has_infant_specialization"
                                   name="has_infant_specialization">
                            <label class="form-check-label" for="has_infant_specialization">
                                Infant Care Specialization (3+ units in infant care)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="is_director"
                                   name="is_director">
                            <label class="form-check-label" for="is_director">
                                This is the Facility Director
                            </label>
                        </div>
                        <div class="form-check ms-4" id="director_ratio_option" style="display: none;">
                            <input class="form-check-input" type="checkbox" id="director_counts_toward_ratio"
                                   name="director_counts_toward_ratio">
                            <label class="form-check-label" for="director_counts_toward_ratio">
                                Director counts toward staffing ratios (teaching role)
                            </label>
                        </div>
                    </div>

                    <div class="alert alert-info small mb-0">
                        <i class="bi bi-info-circle"></i>
                        New staff members are marked as "Available" by default. You can toggle availability later.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Save Staff Member
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Show/hide director ratio option based on director checkbox
document.getElementById('is_director').addEventListener('change', function() {
    const directorRatioOption = document.getElementById('director_ratio_option');
    directorRatioOption.style.display = this.checked ? 'block' : 'none';
    if (!this.checked) {
        document.getElementById('director_counts_toward_ratio').checked = false;
    }
});
</script>
{% endblock %}
