{% extends "base.html" %}

{% block title %}Enrollment Planning{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-sliders"></i> Enrollment Planning</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">Configure enrollment distribution. Changes are saved automatically and flow to the Schedule and other pages.</p>

                <!-- Total Children & Max Capacity -->
                <div class="row mb-4">
                    <div class="col-6">
                        <label class="form-label fw-bold"><i class="bi bi-people-fill"></i> Enrolled</label>
                        <input type="number" class="form-control form-control-lg" id="totalChildren" value="{{ settings.total_children }}" min="1" max="500">
                    </div>
                    <div class="col-6">
                        <label class="form-label fw-bold"><i class="bi bi-building"></i> Licensed Capacity</label>
                        <input type="number" class="form-control form-control-lg" id="maxCapacity" value="{{ settings.max_capacity or 100 }}" min="1" max="500">
                    </div>
                </div>

                <!-- Age Mix -->
                <div class="mb-4">
                    <label class="form-label fw-bold"><i class="bi bi-person-badge"></i> Age Mix</label>
                    <div class="row mb-2">
                        <div class="col-6">
                            <label class="form-label small">Infant (4mo-2yrs)</label>
                            <div class="input-group">
                                <input type="number" class="form-control age-input" id="infantPercent" value="{{ settings.infant_percent|int }}" min="0" max="100">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Child (2+ yrs)</label>
                            <div class="input-group">
                                <input type="number" class="form-control age-input" id="childPercent" value="{{ settings.child_percent|int }}" min="0" max="100">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-warning" id="infantBar" style="width: {{ settings.infant_percent }}%">{{ settings.infant_percent|int }}%</div>
                        <div class="progress-bar bg-success" id="childBar" style="width: {{ settings.child_percent }}%">{{ settings.child_percent|int }}%</div>
                    </div>
                    <small class="text-muted" id="ageValidation">Total: 100%</small>
                </div>

                <!-- Schedule Mix -->
                <div class="mb-4">
                    <label class="form-label fw-bold"><i class="bi bi-clock"></i> Schedule Mix</label>
                    <div class="row mb-2">
                        <div class="col-6">
                            <label class="form-label small">Core (9am-3pm)</label>
                            <div class="input-group">
                                <input type="number" class="form-control schedule-input" id="corePercent" value="{{ settings.core_percent|int }}" min="0" max="100">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Extended (7:30am-5:30pm)</label>
                            <div class="input-group">
                                <input type="number" class="form-control schedule-input" id="extendedPercent" value="{{ settings.extended_percent|int }}" min="0" max="100">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-info" id="coreBar" style="width: {{ settings.core_percent }}%">{{ settings.core_percent|int }}%</div>
                        <div class="progress-bar bg-primary" id="extendedBar" style="width: {{ settings.extended_percent }}%">{{ settings.extended_percent|int }}%</div>
                    </div>
                    <small class="text-muted" id="scheduleValidation">Total: 100%</small>
                </div>

                <!-- Days Mix -->
                <div class="mb-4">
                    <label class="form-label fw-bold"><i class="bi bi-calendar-week"></i> Days/Week Mix</label>
                    <div class="row mb-2">
                        <div class="col-4">
                            <label class="form-label small">Mon-Fri</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control days-input" id="fullPercent" value="{{ settings.full_percent|int }}" min="0" max="100">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <label class="form-label small">M/W/F</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control days-input" id="mwfPercent" value="{{ settings.mwf_percent|int }}" min="0" max="100">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <label class="form-label small">Tu/Th</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control days-input" id="tthPercent" value="{{ settings.tth_percent|int }}" min="0" max="100">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-secondary" id="fullBar" style="width: {{ settings.full_percent }}%">{{ settings.full_percent|int }}%</div>
                        <div class="progress-bar bg-dark" id="mwfBar" style="width: {{ settings.mwf_percent }}%">{{ settings.mwf_percent|int }}%</div>
                        <div class="progress-bar" id="tthBar" style="width: {{ settings.tth_percent }}%; background-color: #6c757d;">{{ settings.tth_percent|int }}%</div>
                    </div>
                    <small class="text-muted" id="daysValidation">Total: 100%</small>
                </div>

                <button type="button" class="btn btn-primary btn-lg w-100" id="saveBtn">
                    <i class="bi bi-save"></i> Save Settings
                </button>
                <div id="saveStatus" class="text-center mt-2" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Update progress bars on input change
    function updateAgeBars() {
        const infant = parseInt(document.getElementById('infantPercent').value) || 0;
        const child = parseInt(document.getElementById('childPercent').value) || 0;
        const total = infant + child;

        document.getElementById('infantBar').style.width = infant + '%';
        document.getElementById('infantBar').textContent = infant + '%';
        document.getElementById('childBar').style.width = child + '%';
        document.getElementById('childBar').textContent = child + '%';

        const validation = document.getElementById('ageValidation');
        if (total === 100) {
            validation.textContent = 'Total: 100%';
            validation.classList.remove('text-danger');
            validation.classList.add('text-muted');
        } else {
            validation.textContent = 'Total: ' + total + '% (must be 100%)';
            validation.classList.remove('text-muted');
            validation.classList.add('text-danger');
        }
    }

    function updateScheduleBars() {
        const core = parseInt(document.getElementById('corePercent').value) || 0;
        const extended = parseInt(document.getElementById('extendedPercent').value) || 0;
        const total = core + extended;

        document.getElementById('coreBar').style.width = core + '%';
        document.getElementById('coreBar').textContent = core + '%';
        document.getElementById('extendedBar').style.width = extended + '%';
        document.getElementById('extendedBar').textContent = extended + '%';

        const validation = document.getElementById('scheduleValidation');
        if (total === 100) {
            validation.textContent = 'Total: 100%';
            validation.classList.remove('text-danger');
            validation.classList.add('text-muted');
        } else {
            validation.textContent = 'Total: ' + total + '% (must be 100%)';
            validation.classList.remove('text-muted');
            validation.classList.add('text-danger');
        }
    }

    function updateDaysBars() {
        const full = parseInt(document.getElementById('fullPercent').value) || 0;
        const mwf = parseInt(document.getElementById('mwfPercent').value) || 0;
        const tth = parseInt(document.getElementById('tthPercent').value) || 0;
        const total = full + mwf + tth;

        document.getElementById('fullBar').style.width = full + '%';
        document.getElementById('fullBar').textContent = full + '%';
        document.getElementById('mwfBar').style.width = mwf + '%';
        document.getElementById('mwfBar').textContent = mwf + '%';
        document.getElementById('tthBar').style.width = tth + '%';
        document.getElementById('tthBar').textContent = tth + '%';

        const validation = document.getElementById('daysValidation');
        if (total === 100) {
            validation.textContent = 'Total: 100%';
            validation.classList.remove('text-danger');
            validation.classList.add('text-muted');
        } else {
            validation.textContent = 'Total: ' + total + '% (must be 100%)';
            validation.classList.remove('text-muted');
            validation.classList.add('text-danger');
        }
    }

    // Attach event listeners
    document.querySelectorAll('.age-input').forEach(input => {
        input.addEventListener('input', updateAgeBars);
    });
    document.querySelectorAll('.schedule-input').forEach(input => {
        input.addEventListener('input', updateScheduleBars);
    });
    document.querySelectorAll('.days-input').forEach(input => {
        input.addEventListener('input', updateDaysBars);
    });

    // Save button
    document.getElementById('saveBtn').addEventListener('click', function() {
        const infantPercent = parseInt(document.getElementById('infantPercent').value) || 0;
        const childPercent = parseInt(document.getElementById('childPercent').value) || 0;
        const corePercent = parseInt(document.getElementById('corePercent').value) || 0;
        const extendedPercent = parseInt(document.getElementById('extendedPercent').value) || 0;
        const fullPercent = parseInt(document.getElementById('fullPercent').value) || 0;
        const mwfPercent = parseInt(document.getElementById('mwfPercent').value) || 0;
        const tthPercent = parseInt(document.getElementById('tthPercent').value) || 0;
        const totalChildren = parseInt(document.getElementById('totalChildren').value) || 50;
        const maxCapacity = parseInt(document.getElementById('maxCapacity').value) || 100;

        // Validate
        if (infantPercent + childPercent !== 100) {
            showStatus('Age mix must total 100%', 'danger');
            return;
        }
        if (corePercent + extendedPercent !== 100) {
            showStatus('Schedule mix must total 100%', 'danger');
            return;
        }
        if (fullPercent + mwfPercent + tthPercent !== 100) {
            showStatus('Days mix must total 100%', 'danger');
            return;
        }

        const data = {
            age_mix: { infant: infantPercent, child: childPercent },
            schedule_mix: { core: corePercent, extended: extendedPercent },
            days_mix: { full: fullPercent, mwf: mwfPercent, tth: tthPercent },
            total_children: totalChildren,
            max_capacity: maxCapacity
        };

        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass"></i> Saving...';

        fetch('/capacity-planner/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-save"></i> Save Settings';
            if (result.success) {
                showStatus('Settings saved successfully!', 'success');
            } else {
                showStatus(result.error || 'Error saving settings', 'danger');
            }
        })
        .catch(error => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-save"></i> Save Settings';
            console.error('Error:', error);
            showStatus('Error saving settings', 'danger');
        });
    });

    function showStatus(message, type) {
        const statusEl = document.getElementById('saveStatus');
        statusEl.style.display = 'block';
        statusEl.className = 'text-center mt-2 text-' + type;
        statusEl.innerHTML = '<small>' + message + '</small>';

        // Hide after 3 seconds
        setTimeout(() => {
            statusEl.style.display = 'none';
        }, 3000);
    }
});
</script>
{% endblock %}
