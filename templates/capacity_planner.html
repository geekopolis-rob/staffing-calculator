{% extends "base.html" %}

{% block title %}Enrollment Planning{% endblock %}

{% block styles %}
<style>
    .progress-slider {
        position: relative;
        cursor: pointer;
    }
    .progress-divider {
        position: absolute;
        width: 18px;
        height: 100%;
        background: rgba(255,255,255,0.9);
        border: 2px solid #333;
        border-radius: 3px;
        cursor: ew-resize;
        transform: translateX(-50%);
        z-index: 10;
        top: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .progress-divider::before {
        content: "|||";
        font-size: 8px;
        color: #666;
        letter-spacing: -1px;
    }
    .progress-divider:hover,
    .progress-divider.dragging {
        background: white;
        box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-sliders"></i> Enrollment Planning</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">Configure enrollment distribution. Changes are saved automatically and flow to the Schedule and other pages.</p>

                <!-- Total Children & Max Capacity -->
                <div class="row mb-4">
                    <div class="col-6">
                        <label class="form-label fw-bold"><i class="bi bi-people-fill"></i> Enrolled</label>
                        <input type="number" class="form-control form-control-lg" id="totalChildren" value="{{ settings.total_children }}" min="1" max="500">
                    </div>
                    <div class="col-6">
                        <label class="form-label fw-bold"><i class="bi bi-building"></i> Licensed Capacity</label>
                        <input type="number" class="form-control form-control-lg" id="maxCapacity" value="{{ settings.max_capacity or 100 }}" min="1" max="500">
                    </div>
                </div>

                <!-- Age Mix -->
                <div class="mb-4">
                    <label class="form-label fw-bold"><i class="bi bi-person-badge"></i> Age Mix</label>
                    <div class="row mb-2">
                        <div class="col-6">
                            <label class="form-label small">Infant (4mo-2yrs)</label>
                            <div class="input-group">
                                <input type="number" class="form-control age-input" id="infantPercent" value="{{ settings.infant_percent|int }}" min="0" max="100">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Child (2+ yrs)</label>
                            <div class="input-group">
                                <input type="number" class="form-control age-input" id="childPercent" value="{{ settings.child_percent|int }}" min="0" max="100">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="progress progress-slider" id="ageSlider" style="height: 20px;">
                        <div class="progress-bar bg-warning" id="infantBar" style="width: {{ settings.infant_percent }}%">{{ settings.infant_percent|int }}%</div>
                        <div class="progress-bar bg-success" id="childBar" style="width: {{ settings.child_percent }}%">{{ settings.child_percent|int }}%</div>
                        <div class="progress-divider" id="ageDivider" style="left: {{ settings.infant_percent }}%"></div>
                    </div>
                    <small class="text-muted" id="ageValidation">Total: 100%</small>
                </div>

                <!-- Schedule Mix -->
                <div class="mb-4">
                    <label class="form-label fw-bold"><i class="bi bi-clock"></i> Schedule Mix</label>
                    <div class="row mb-2">
                        <div class="col-6">
                            <label class="form-label small">Core (9am-3pm)</label>
                            <div class="input-group">
                                <input type="number" class="form-control schedule-input" id="corePercent" value="{{ settings.core_percent|int }}" min="0" max="100">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Extended (7:30am-5:30pm)</label>
                            <div class="input-group">
                                <input type="number" class="form-control schedule-input" id="extendedPercent" value="{{ settings.extended_percent|int }}" min="0" max="100">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="progress progress-slider" id="scheduleSlider" style="height: 20px;">
                        <div class="progress-bar bg-info" id="coreBar" style="width: {{ settings.core_percent }}%">{{ settings.core_percent|int }}%</div>
                        <div class="progress-bar bg-primary" id="extendedBar" style="width: {{ settings.extended_percent }}%">{{ settings.extended_percent|int }}%</div>
                        <div class="progress-divider" id="scheduleDivider" style="left: {{ settings.core_percent }}%"></div>
                    </div>
                    <small class="text-muted" id="scheduleValidation">Total: 100%</small>
                </div>

                <!-- Days Mix -->
                <div class="mb-4">
                    <label class="form-label fw-bold"><i class="bi bi-calendar-week"></i> Days/Week Mix</label>
                    <div class="row mb-2">
                        <div class="col-4">
                            <label class="form-label small">Mon-Fri</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control days-input" id="fullPercent" value="{{ settings.full_percent|int }}" min="0" max="100">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <label class="form-label small">M/W/F</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control days-input" id="mwfPercent" value="{{ settings.mwf_percent|int }}" min="0" max="100">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                        <div class="col-4">
                            <label class="form-label small">Tu/Th</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control days-input" id="tthPercent" value="{{ settings.tth_percent|int }}" min="0" max="100">
                                <span class="input-group-text">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="progress progress-slider" id="daysSlider" style="height: 20px;">
                        <div class="progress-bar bg-secondary" id="fullBar" style="width: {{ settings.full_percent }}%">{{ settings.full_percent|int }}%</div>
                        <div class="progress-bar bg-dark" id="mwfBar" style="width: {{ settings.mwf_percent }}%">{{ settings.mwf_percent|int }}%</div>
                        <div class="progress-bar" id="tthBar" style="width: {{ settings.tth_percent }}%; background-color: #6c757d;">{{ settings.tth_percent|int }}%</div>
                        <div class="progress-divider" id="daysDivider1" style="left: {{ settings.full_percent }}%"></div>
                        <div class="progress-divider" id="daysDivider2" style="left: {{ settings.full_percent + settings.mwf_percent }}%"></div>
                    </div>
                    <small class="text-muted" id="daysValidation">Total: 100%</small>
                </div>

                <button type="button" class="btn btn-primary btn-lg w-100" id="saveBtn">
                    <i class="bi bi-save"></i> Save Settings
                </button>
                <div id="saveStatus" class="text-center mt-2" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Snap value to nearest 5%
    function snapTo5(value) {
        return Math.round(value / 5) * 5;
    }

    // Clamp value between min and max
    function clamp(value, min, max) {
        return Math.max(min, Math.min(max, value));
    }

    // Update progress bars on input change
    function updateAgeBars() {
        const infant = parseInt(document.getElementById('infantPercent').value) || 0;
        const child = parseInt(document.getElementById('childPercent').value) || 0;
        const total = infant + child;

        document.getElementById('infantBar').style.width = infant + '%';
        document.getElementById('infantBar').textContent = infant + '%';
        document.getElementById('childBar').style.width = child + '%';
        document.getElementById('childBar').textContent = child + '%';
        document.getElementById('ageDivider').style.left = infant + '%';

        const validation = document.getElementById('ageValidation');
        if (total === 100) {
            validation.textContent = 'Total: 100%';
            validation.classList.remove('text-danger');
            validation.classList.add('text-muted');
        } else {
            validation.textContent = 'Total: ' + total + '% (must be 100%)';
            validation.classList.remove('text-muted');
            validation.classList.add('text-danger');
        }
    }

    function updateScheduleBars() {
        const core = parseInt(document.getElementById('corePercent').value) || 0;
        const extended = parseInt(document.getElementById('extendedPercent').value) || 0;
        const total = core + extended;

        document.getElementById('coreBar').style.width = core + '%';
        document.getElementById('coreBar').textContent = core + '%';
        document.getElementById('extendedBar').style.width = extended + '%';
        document.getElementById('extendedBar').textContent = extended + '%';
        document.getElementById('scheduleDivider').style.left = core + '%';

        const validation = document.getElementById('scheduleValidation');
        if (total === 100) {
            validation.textContent = 'Total: 100%';
            validation.classList.remove('text-danger');
            validation.classList.add('text-muted');
        } else {
            validation.textContent = 'Total: ' + total + '% (must be 100%)';
            validation.classList.remove('text-muted');
            validation.classList.add('text-danger');
        }
    }

    function updateDaysBars() {
        const full = parseInt(document.getElementById('fullPercent').value) || 0;
        const mwf = parseInt(document.getElementById('mwfPercent').value) || 0;
        const tth = parseInt(document.getElementById('tthPercent').value) || 0;
        const total = full + mwf + tth;

        document.getElementById('fullBar').style.width = full + '%';
        document.getElementById('fullBar').textContent = full + '%';
        document.getElementById('mwfBar').style.width = mwf + '%';
        document.getElementById('mwfBar').textContent = mwf + '%';
        document.getElementById('tthBar').style.width = tth + '%';
        document.getElementById('tthBar').textContent = tth + '%';
        document.getElementById('daysDivider1').style.left = full + '%';
        document.getElementById('daysDivider2').style.left = (full + mwf) + '%';

        const validation = document.getElementById('daysValidation');
        if (total === 100) {
            validation.textContent = 'Total: 100%';
            validation.classList.remove('text-danger');
            validation.classList.add('text-muted');
        } else {
            validation.textContent = 'Total: ' + total + '% (must be 100%)';
            validation.classList.remove('text-muted');
            validation.classList.add('text-danger');
        }
    }

    // Snap on blur for input fields
    function setupSnapOnBlur(inputId, complementId, updateFn) {
        const input = document.getElementById(inputId);
        input.addEventListener('blur', function() {
            let value = parseInt(this.value) || 0;
            value = clamp(snapTo5(value), 0, 100);
            this.value = value;
            // Update complement to maintain 100%
            document.getElementById(complementId).value = 100 - value;
            updateFn();
        });
    }

    function setupSnapOnBlur3(inputId, input2Id, input3Id, updateFn) {
        const input = document.getElementById(inputId);
        input.addEventListener('blur', function() {
            let value = parseInt(this.value) || 0;
            value = clamp(snapTo5(value), 0, 100);
            this.value = value;
            // Adjust the other two to maintain 100% (proportionally if possible)
            const other1 = parseInt(document.getElementById(input2Id).value) || 0;
            const other2 = parseInt(document.getElementById(input3Id).value) || 0;
            const remaining = 100 - value;
            if (other1 + other2 > 0) {
                const ratio = remaining / (other1 + other2);
                document.getElementById(input2Id).value = snapTo5(Math.round(other1 * ratio));
                document.getElementById(input3Id).value = 100 - value - parseInt(document.getElementById(input2Id).value);
            } else {
                document.getElementById(input2Id).value = remaining;
                document.getElementById(input3Id).value = 0;
            }
            updateFn();
        });
    }

    // Setup snap on blur for 2-value groups
    setupSnapOnBlur('infantPercent', 'childPercent', updateAgeBars);
    setupSnapOnBlur('childPercent', 'infantPercent', updateAgeBars);
    setupSnapOnBlur('corePercent', 'extendedPercent', updateScheduleBars);
    setupSnapOnBlur('extendedPercent', 'corePercent', updateScheduleBars);

    // Setup snap on blur for 3-value group
    setupSnapOnBlur3('fullPercent', 'mwfPercent', 'tthPercent', updateDaysBars);
    setupSnapOnBlur3('mwfPercent', 'fullPercent', 'tthPercent', updateDaysBars);
    setupSnapOnBlur3('tthPercent', 'fullPercent', 'mwfPercent', updateDaysBars);

    // Dragging functionality for 2-segment sliders
    function setupDrag2(sliderId, dividerId, input1Id, input2Id, updateFn) {
        const slider = document.getElementById(sliderId);
        const divider = document.getElementById(dividerId);
        let isDragging = false;

        function getPercentFromEvent(e) {
            const rect = slider.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const x = clientX - rect.left;
            const percent = (x / rect.width) * 100;
            return clamp(snapTo5(percent), 0, 100);
        }

        function onDragStart(e) {
            isDragging = true;
            divider.classList.add('dragging');
            e.preventDefault();
        }

        function onDragMove(e) {
            if (!isDragging) return;
            const percent = getPercentFromEvent(e);
            document.getElementById(input1Id).value = percent;
            document.getElementById(input2Id).value = 100 - percent;
            updateFn();
        }

        function onDragEnd() {
            isDragging = false;
            divider.classList.remove('dragging');
        }

        divider.addEventListener('mousedown', onDragStart);
        divider.addEventListener('touchstart', onDragStart);
        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('touchmove', onDragMove);
        document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchend', onDragEnd);

        // Also allow clicking anywhere on the slider
        slider.addEventListener('click', function(e) {
            if (e.target === divider) return;
            const percent = getPercentFromEvent(e);
            document.getElementById(input1Id).value = percent;
            document.getElementById(input2Id).value = 100 - percent;
            updateFn();
        });
    }

    // Dragging functionality for 3-segment slider
    function setupDrag3(sliderId, divider1Id, divider2Id, input1Id, input2Id, input3Id, updateFn) {
        const slider = document.getElementById(sliderId);
        const divider1 = document.getElementById(divider1Id);
        const divider2 = document.getElementById(divider2Id);
        let activeDivider = null;

        function getPercentFromEvent(e) {
            const rect = slider.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const x = clientX - rect.left;
            return (x / rect.width) * 100;
        }

        function onDragStart(e, divider) {
            activeDivider = divider;
            divider.classList.add('dragging');
            e.preventDefault();
        }

        function onDragMove(e) {
            if (!activeDivider) return;
            const rawPercent = getPercentFromEvent(e);
            const full = parseInt(document.getElementById(input1Id).value) || 0;
            const mwf = parseInt(document.getElementById(input2Id).value) || 0;

            if (activeDivider === divider1) {
                // Moving first divider: adjusts full and mwf
                const newFull = clamp(snapTo5(rawPercent), 0, 100 - parseInt(document.getElementById(input3Id).value));
                const oldBoundary = full + mwf;
                document.getElementById(input1Id).value = newFull;
                document.getElementById(input2Id).value = Math.max(0, oldBoundary - newFull);
                // tth stays the same, but recalculate to ensure 100%
                document.getElementById(input3Id).value = 100 - newFull - parseInt(document.getElementById(input2Id).value);
            } else {
                // Moving second divider: adjusts mwf and tth
                const boundary = clamp(snapTo5(rawPercent), full, 100);
                document.getElementById(input2Id).value = boundary - full;
                document.getElementById(input3Id).value = 100 - boundary;
            }
            updateFn();
        }

        function onDragEnd() {
            if (activeDivider) {
                activeDivider.classList.remove('dragging');
            }
            activeDivider = null;
        }

        divider1.addEventListener('mousedown', (e) => onDragStart(e, divider1));
        divider1.addEventListener('touchstart', (e) => onDragStart(e, divider1));
        divider2.addEventListener('mousedown', (e) => onDragStart(e, divider2));
        divider2.addEventListener('touchstart', (e) => onDragStart(e, divider2));
        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('touchmove', onDragMove);
        document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchend', onDragEnd);
    }

    // Setup drag handlers
    setupDrag2('ageSlider', 'ageDivider', 'infantPercent', 'childPercent', updateAgeBars);
    setupDrag2('scheduleSlider', 'scheduleDivider', 'corePercent', 'extendedPercent', updateScheduleBars);
    setupDrag3('daysSlider', 'daysDivider1', 'daysDivider2', 'fullPercent', 'mwfPercent', 'tthPercent', updateDaysBars);

    // Attach event listeners for real-time bar updates while typing
    document.querySelectorAll('.age-input').forEach(input => {
        input.addEventListener('input', updateAgeBars);
    });
    document.querySelectorAll('.schedule-input').forEach(input => {
        input.addEventListener('input', updateScheduleBars);
    });
    document.querySelectorAll('.days-input').forEach(input => {
        input.addEventListener('input', updateDaysBars);
    });

    // Save button
    document.getElementById('saveBtn').addEventListener('click', function() {
        const infantPercent = parseInt(document.getElementById('infantPercent').value) || 0;
        const childPercent = parseInt(document.getElementById('childPercent').value) || 0;
        const corePercent = parseInt(document.getElementById('corePercent').value) || 0;
        const extendedPercent = parseInt(document.getElementById('extendedPercent').value) || 0;
        const fullPercent = parseInt(document.getElementById('fullPercent').value) || 0;
        const mwfPercent = parseInt(document.getElementById('mwfPercent').value) || 0;
        const tthPercent = parseInt(document.getElementById('tthPercent').value) || 0;
        const totalChildren = parseInt(document.getElementById('totalChildren').value) || 50;
        const maxCapacity = parseInt(document.getElementById('maxCapacity').value) || 100;

        // Validate
        if (infantPercent + childPercent !== 100) {
            showStatus('Age mix must total 100%', 'danger');
            return;
        }
        if (corePercent + extendedPercent !== 100) {
            showStatus('Schedule mix must total 100%', 'danger');
            return;
        }
        if (fullPercent + mwfPercent + tthPercent !== 100) {
            showStatus('Days mix must total 100%', 'danger');
            return;
        }

        const data = {
            age_mix: { infant: infantPercent, child: childPercent },
            schedule_mix: { core: corePercent, extended: extendedPercent },
            days_mix: { full: fullPercent, mwf: mwfPercent, tth: tthPercent },
            total_children: totalChildren,
            max_capacity: maxCapacity
        };

        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass"></i> Saving...';

        fetch('/capacity-planner/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-save"></i> Save Settings';
            if (result.success) {
                showStatus('Settings saved successfully!', 'success');
            } else {
                showStatus(result.error || 'Error saving settings', 'danger');
            }
        })
        .catch(error => {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-save"></i> Save Settings';
            console.error('Error:', error);
            showStatus('Error saving settings', 'danger');
        });
    });

    function showStatus(message, type) {
        const statusEl = document.getElementById('saveStatus');
        statusEl.style.display = 'block';
        statusEl.className = 'text-center mt-2 text-' + type;
        statusEl.innerHTML = '<small>' + message + '</small>';

        // Hide after 3 seconds
        setTimeout(() => {
            statusEl.style.display = 'none';
        }, 3000);
    }
});
</script>
{% endblock %}
