{% extends "base.html" %}

{% block title %}Pricing Calculator{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-calculator"></i> Tuition Calculator</h5>
            </div>
            <div class="card-body">
                <form id="pricingForm">
                    <!-- Step 1: Age Group Selection -->
                    <div class="mb-4">
                        <h6><i class="bi bi-person-circle"></i> Step 1: Select Age Group</h6>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="age_group_type" id="age_infant" value="infant" autocomplete="off">
                            <label class="btn btn-outline-primary py-3" for="age_infant">
                                <span class="fs-4">ðŸ‘¶</span><br>
                                <strong>Infant</strong><br>
                                <small>4 months - 2 years</small>
                            </label>

                            <input type="radio" class="btn-check" name="age_group_type" id="age_child" value="child" autocomplete="off">
                            <label class="btn btn-outline-primary py-3" for="age_child">
                                <span class="fs-4">ðŸ§’</span><br>
                                <strong>Child</strong><br>
                                <small>2+ years</small>
                            </label>
                        </div>
                    </div>

                    <!-- Step 2: Schedule Selection -->
                    <div class="mb-4" id="scheduleSection" style="display: none;">
                        <h6><i class="bi bi-calendar-week"></i> Step 2: Select Schedule</h6>
                        <div class="row" id="planCards">
                            <!-- Core Hours (top row) - ordered: 5 days, 3 days, 2 days -->
                            {% for day_pattern in ['full', 'mwf', 'tth'] %}
                            {% for plan in core_plans if plan.is_fixed_plan and plan.is_active and plan.schedule_type == 'core' and plan.day_pattern == day_pattern %}
                            <div class="col-md-4 mb-3 plan-card"
                                 data-age-type="{{ plan.age_group_type }}"
                                 data-schedule-type="{{ plan.schedule_type }}"
                                 data-day-pattern="{{ plan.day_pattern }}"
                                 style="display: none;">
                                <div class="card h-100 plan-selectable" data-plan-id="{{ plan.id }}">
                                    <div class="card-header text-white bg-info">
                                        <strong>Core Hours</strong>
                                    </div>
                                    <div class="card-body text-center">
                                        <p class="mb-2">
                                            <i class="bi bi-clock"></i> 9:00 AM - 3:00 PM
                                        </p>
                                        <p class="mb-2">
                                            <i class="bi bi-calendar3"></i>
                                            {% if plan.day_pattern == 'full' %}Mon - Fri (5 days)
                                            {% elif plan.day_pattern == 'mwf' %}Mon, Wed, Fri (3 days)
                                            {% else %}Tue, Thu (2 days)
                                            {% endif %}
                                        </p>
                                        <h4 class="text-success mb-0">${{ plan.base_price|int }}<small>/month</small></h4>
                                    </div>
                                    <div class="card-footer">
                                        <div class="form-check">
                                            <input class="form-check-input plan-radio" type="radio"
                                                   name="selected_plan" value="{{ plan.id }}"
                                                   data-price="{{ plan.base_price }}"
                                                   data-days-count="{{ plan.get_days_count() }}"
                                                   data-age-type="{{ plan.age_group_type }}"
                                                   id="plan_{{ plan.id }}">
                                            <label class="form-check-label" for="plan_{{ plan.id }}">
                                                Select this plan
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% endfor %}
                            <!-- Extended Hours (bottom row) - ordered: 5 days, 3 days, 2 days -->
                            {% for day_pattern in ['full', 'mwf', 'tth'] %}
                            {% for plan in core_plans if plan.is_fixed_plan and plan.is_active and plan.schedule_type == 'extended' and plan.day_pattern == day_pattern %}
                            <div class="col-md-4 mb-3 plan-card"
                                 data-age-type="{{ plan.age_group_type }}"
                                 data-schedule-type="{{ plan.schedule_type }}"
                                 data-day-pattern="{{ plan.day_pattern }}"
                                 style="display: none;">
                                <div class="card h-100 plan-selectable" data-plan-id="{{ plan.id }}">
                                    <div class="card-header text-white bg-success">
                                        <strong>Extended Hours</strong>
                                    </div>
                                    <div class="card-body text-center">
                                        <p class="mb-2">
                                            <i class="bi bi-clock"></i> 7:30 AM - 5:30 PM
                                        </p>
                                        <p class="mb-2">
                                            <i class="bi bi-calendar3"></i>
                                            {% if plan.day_pattern == 'full' %}Mon - Fri (5 days)
                                            {% elif plan.day_pattern == 'mwf' %}Mon, Wed, Fri (3 days)
                                            {% else %}Tue, Thu (2 days)
                                            {% endif %}
                                        </p>
                                        <h4 class="text-success mb-0">${{ plan.base_price|int }}<small>/month</small></h4>
                                    </div>
                                    <div class="card-footer">
                                        <div class="form-check">
                                            <input class="form-check-input plan-radio" type="radio"
                                                   name="selected_plan" value="{{ plan.id }}"
                                                   data-price="{{ plan.base_price }}"
                                                   data-days-count="{{ plan.get_days_count() }}"
                                                   data-age-type="{{ plan.age_group_type }}"
                                                   id="plan_{{ plan.id }}">
                                            <label class="form-check-label" for="plan_{{ plan.id }}">
                                                Select this plan
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Add-Ons Section -->
                    {% if add_ons %}
                    <div class="mb-4" id="addonsSection" style="display: none;">
                        <h6><i class="bi bi-plus-square"></i> Step 3: Select Add-Ons (Optional)</h6>
                        <div class="accordion" id="addonsAccordion">
                            {% for addon in add_ons %}
                            {% if not addon.is_extended_care %}
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#addon_{{ addon.id }}">
                                        {{ addon.name }}
                                        <span class="badge bg-success ms-2">
                                            {% if addon.pricing_type == 'per_day' %}
                                            ${{ "%.2f"|format(addon.price) }}/day
                                            {% elif addon.pricing_type == 'time_based' %}
                                            ${{ "%.2f"|format(addon.price) }}/{{ addon.minutes_unit }}min
                                            {% else %}
                                            ${{ "%.2f"|format(addon.price) }} one-time
                                            {% endif %}
                                        </span>
                                    </button>
                                </h2>
                                <div id="addon_{{ addon.id }}" class="accordion-collapse collapse">
                                    <div class="accordion-body">
                                        {% if addon.description %}
                                        <p class="text-muted mb-3">{{ addon.description }}</p>
                                        {% endif %}

                                        <div class="form-check mb-3">
                                            <input class="form-check-input addon-checkbox" type="checkbox"
                                                   data-addon-id="{{ addon.id }}"
                                                   data-addon-name="{{ addon.name }}"
                                                   data-pricing-type="{{ addon.pricing_type }}"
                                                   data-price="{{ addon.price }}"
                                                   data-minutes-unit="{{ addon.minutes_unit }}"
                                                   id="addon_check_{{ addon.id }}">
                                            <label class="form-check-label" for="addon_check_{{ addon.id }}">
                                                Add this service
                                            </label>
                                        </div>

                                        <!-- Quantity/Input Fields -->
                                        <div class="addon-inputs" id="addon_input_{{ addon.id }}" style="display: none;">
                                            {% if addon.pricing_type == 'per_day' %}
                                            <div class="mb-2">
                                                <label class="form-label">Days per week</label>
                                                <input type="number" class="form-control addon-quantity"
                                                       data-addon-id="{{ addon.id }}"
                                                       min="1" max="5" value="1">
                                            </div>
                                            {% elif addon.pricing_type == 'time_based' %}
                                            <div class="mb-2">
                                                <label class="form-label">Total minutes needed</label>
                                                <input type="number" class="form-control addon-quantity"
                                                       data-addon-id="{{ addon.id }}"
                                                       min="{{ addon.minutes_unit }}"
                                                       step="{{ addon.minutes_unit }}"
                                                       value="{{ addon.minutes_unit }}">
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- One-Time Fees Section -->
                    {% if fees %}
                    <div class="mb-4">
                        <h6><i class="bi bi-receipt"></i> Step 4: Select Applicable Fees (Optional)</h6>
                        <div class="list-group">
                            {% for fee in fees %}
                            <label class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div class="form-check">
                                        <input class="form-check-input fee-checkbox" type="checkbox"
                                               value="{{ fee.id }}"
                                               data-amount="{{ fee.amount }}"
                                               id="fee_{{ fee.id }}">
                                        <label class="form-check-label" for="fee_{{ fee.id }}">
                                            <strong>{{ fee.name }}</strong>
                                            <span class="badge bg-secondary">{{ fee.fee_type|title }}</span>
                                            {% if fee.is_refundable %}
                                            <span class="badge bg-success">Refundable</span>
                                            {% endif %}
                                            {% if fee.description %}
                                            <br><small class="text-muted">{{ fee.description }}</small>
                                            {% endif %}
                                        </label>
                                    </div>
                                    <span class="badge bg-warning text-dark fs-6">
                                        ${{ "%.2f"|format(fee.amount) }}
                                    </span>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Discounts Section -->
                    {% if discounts %}
                    <div class="mb-4">
                        <h6><i class="bi bi-percent"></i> Step 5: Apply Discounts (Optional)</h6>
                        <div class="list-group">
                            {% for discount in discounts %}
                            <label class="list-group-item">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div class="form-check">
                                        <input class="form-check-input discount-checkbox" type="checkbox"
                                               value="{{ discount.id }}"
                                               data-type="{{ discount.discount_type }}"
                                               data-amount="{{ discount.amount }}"
                                               data-applies-to="{{ discount.applies_to }}"
                                               id="discount_{{ discount.id }}">
                                        <label class="form-check-label" for="discount_{{ discount.id }}">
                                            <strong>{{ discount.name }}</strong>
                                            <span class="badge bg-info">{{ discount.applies_to|replace('_', ' ')|title }}</span>
                                            {% if discount.description %}
                                            <br><small class="text-muted">{{ discount.description }}</small>
                                            {% endif %}
                                            {% if discount.conditions %}
                                            <br><small class="text-muted"><em>Conditions: {{ discount.conditions }}</em></small>
                                            {% endif %}
                                        </label>
                                    </div>
                                    <span class="badge bg-danger fs-6">
                                        {% if discount.discount_type == 'percentage' %}
                                        -{{ discount.amount }}%
                                        {% else %}
                                        -${{ "%.2f"|format(discount.amount) }}
                                        {% endif %}
                                    </span>
                                </div>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>

    <!-- Summary Sidebar -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="bi bi-receipt-cutoff"></i> Price Summary</h5>
            </div>
            <div class="card-body">
                <div id="summary-content">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Select a core plan to see your total
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Package Modal -->
<div class="modal fade" id="savePackageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-box-seam"></i> Save as Package</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_package') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="package_name" class="form-label">Package Name</label>
                        <input type="text" class="form-control" id="package_name" name="name"
                               placeholder="e.g., Full-Time with Extended Care" required>
                    </div>
                    <div class="mb-3">
                        <label for="package_short_code" class="form-label">Short Code (for calendar display)</label>
                        <input type="text" class="form-control" id="package_short_code" name="short_code"
                               placeholder="e.g., FT, FT-EC, PT" maxlength="10">
                        <small class="form-text text-muted">Short code to display on the schedule (10 characters max)</small>
                    </div>
                    <div class="mb-3">
                        <label for="package_description" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="package_description" name="description" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="package_age_group" class="form-label">Age Group (Optional)</label>
                        <select class="form-select" id="package_age_group" name="age_group_id">
                            <option value="">All Age Groups</option>
                            {% for ag in age_groups %}
                            <option value="{{ ag.id }}">{{ ag.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="package_active" name="is_active" checked>
                        <label class="form-check-label" for="package_active">Active</label>
                    </div>

                    <!-- Hidden fields -->
                    <input type="hidden" id="package_core_plan_id" name="core_plan_id">
                    <input type="hidden" id="package_monthly_tuition" name="monthly_tuition">
                    <input type="hidden" id="package_extended_start" name="extended_care_start_time">
                    <input type="hidden" id="package_extended_end" name="extended_care_end_time">
                    <input type="hidden" id="package_addons_json" name="addons_json">
                    <input type="hidden" id="package_fees_json" name="fees_json">
                    <input type="hidden" id="package_discounts_json" name="discounts_json">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> Save Package
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedCorePlan = null;
let selectedAddons = [];
let selectedFees = [];
let selectedDiscounts = [];

// Age group selection - filter and show plan cards
document.querySelectorAll('input[name="age_group_type"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const selectedAge = this.value;

        // Show schedule section
        document.getElementById('scheduleSection').style.display = 'block';

        // Reset any previously selected plan
        document.querySelectorAll('.plan-radio').forEach(r => r.checked = false);
        document.querySelectorAll('.plan-selectable').forEach(card => {
            card.classList.remove('border-primary', 'border-3');
        });
        selectedCorePlan = null;

        // Hide add-ons section until plan is selected
        const addonsSection = document.getElementById('addonsSection');
        if (addonsSection) addonsSection.style.display = 'none';

        // Show/hide plan cards based on age group
        document.querySelectorAll('.plan-card').forEach(card => {
            if (card.dataset.ageType === selectedAge) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });

        calculateTotal();
    });
});

// Plan card selection
document.querySelectorAll('.plan-radio').forEach(radio => {
    radio.addEventListener('change', function() {
        // Remove highlight from all cards
        document.querySelectorAll('.plan-selectable').forEach(card => {
            card.classList.remove('border-primary', 'border-3');
        });

        // Highlight selected card
        const card = this.closest('.plan-selectable');
        if (card) {
            card.classList.add('border-primary', 'border-3');
        }

        selectedCorePlan = {
            id: this.value,
            price: parseFloat(this.dataset.price),
            period: 'monthly',
            daysCount: parseInt(this.dataset.daysCount),
            ageType: this.dataset.ageType
        };

        // Show add-ons section
        const addonsSection = document.getElementById('addonsSection');
        if (addonsSection) addonsSection.style.display = 'block';

        // Update max days for per_day add-ons
        document.querySelectorAll('.addon-quantity').forEach(input => {
            const checkbox = document.querySelector(`.addon-checkbox[data-addon-id="${input.dataset.addonId}"]`);
            if (checkbox && checkbox.dataset.pricingType === 'per_day') {
                input.max = selectedCorePlan.daysCount;
                if (parseInt(input.value) > selectedCorePlan.daysCount) {
                    input.value = selectedCorePlan.daysCount;
                }
            }
        });

        calculateTotal();
    });
});

// Make entire card clickable
document.querySelectorAll('.plan-selectable').forEach(card => {
    card.style.cursor = 'pointer';
    card.addEventListener('click', function(e) {
        // Don't trigger if clicking directly on the radio button
        if (e.target.type !== 'radio') {
            const radio = this.querySelector('.plan-radio');
            if (radio && !radio.disabled) {
                radio.checked = true;
                radio.dispatchEvent(new Event('change'));
            }
        }
    });
});

calculateTotal();

// Add-on checkboxes
document.querySelectorAll('.addon-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const addonId = this.dataset.addonId;
        const inputDiv = document.getElementById(`addon_input_${addonId}`);

        if (this.checked) {
            inputDiv.style.display = 'block';
            updateAddon(addonId);
        } else {
            inputDiv.style.display = 'none';
            selectedAddons = selectedAddons.filter(a => a.id !== addonId);
            calculateTotal();
        }
    });
});

// Add-on quantity inputs
document.querySelectorAll('.addon-quantity').forEach(input => {
    input.addEventListener('input', function() {
        updateAddon(this.dataset.addonId);
    });
});

function updateAddon(addonId) {
    const checkbox = document.querySelector(`.addon-checkbox[data-addon-id="${addonId}"]`);
    if (!checkbox.checked) return;

    const pricingType = checkbox.dataset.pricingType;
    const basePrice = parseFloat(checkbox.dataset.price);
    const minutesUnit = parseInt(checkbox.dataset.minutesUnit);

    let totalPrice = basePrice;
    let quantity = 1;

    const quantityInput = document.querySelector(`.addon-quantity[data-addon-id="${addonId}"]`);
    if (quantityInput) {
        quantity = parseInt(quantityInput.value) || 1;
    }

    if (pricingType === 'per_day') {
        // Per day pricing - multiply by weeks in billing period
        const weeksInPeriod = selectedCorePlan?.period === 'monthly' ? 4 : 1;
        totalPrice = basePrice * quantity * weeksInPeriod;
    } else if (pricingType === 'time_based') {
        // Time-based pricing - calculate based on minutes
        const units = Math.ceil(quantity / minutesUnit);
        totalPrice = basePrice * units;
    }
    // one_time stays as base price

    // Update or add to selectedAddons
    const existingIndex = selectedAddons.findIndex(a => a.id === addonId);
    const addon = {
        id: addonId,
        price: totalPrice,
        quantity: quantity,
        type: pricingType
    };

    if (existingIndex >= 0) {
        selectedAddons[existingIndex] = addon;
    } else {
        selectedAddons.push(addon);
    }

    calculateTotal();
}

// Fee checkboxes
document.querySelectorAll('.fee-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        if (this.checked) {
            selectedFees.push({
                id: this.value,
                amount: parseFloat(this.dataset.amount)
            });
        } else {
            selectedFees = selectedFees.filter(f => f.id !== this.value);
        }
        calculateTotal();
    });
});

// Discount checkboxes
document.querySelectorAll('.discount-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        if (this.checked) {
            selectedDiscounts.push({
                id: this.value,
                type: this.dataset.type,
                amount: parseFloat(this.dataset.amount),
                appliesTo: this.dataset.appliesTo
            });
        } else {
            selectedDiscounts = selectedDiscounts.filter(d => d.id !== this.value);
        }
        calculateTotal();
    });
});

function calculateTotal() {
    if (!selectedCorePlan) {
        document.getElementById('summary-content').innerHTML = `
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                Select a core plan to see your total
            </div>
        `;
        return;
    }

    let html = '<div class="mb-3">';

    // Core Plan
    html += '<h6 class="border-bottom pb-2">Core Plan</h6>';
    html += `<div class="d-flex justify-content-between mb-2">
        <span>Base tuition (${selectedCorePlan.period})</span>
        <strong>$${selectedCorePlan.price.toFixed(2)}</strong>
    </div>`;

    let corePlanTotal = selectedCorePlan.price;
    let addonsTotal = 0;
    let feesTotal = 0;

    // Add-ons
    if (selectedAddons.length > 0) {
        html += '<h6 class="border-bottom pb-2 mt-3">Add-Ons</h6>';
        selectedAddons.forEach(addon => {
            const checkbox = document.querySelector(`.addon-checkbox[data-addon-id="${addon.id}"]`);
            const addonName = checkbox.dataset.addonName;
            html += `<div class="d-flex justify-content-between mb-2">
                <small>${addonName}</small>
                <span>$${addon.price.toFixed(2)}</span>
            </div>`;
            addonsTotal += addon.price;
        });
    }

    // Fees
    if (selectedFees.length > 0) {
        html += '<h6 class="border-bottom pb-2 mt-3">One-Time Fees</h6>';
        selectedFees.forEach(fee => {
            const label = document.querySelector(`label[for="fee_${fee.id}"]`).querySelector('strong').textContent;
            html += `<div class="d-flex justify-content-between mb-2">
                <small>${label}</small>
                <span>$${fee.amount.toFixed(2)}</span>
            </div>`;
            feesTotal += fee.amount;
        });
    }

    // Subtotals
    let subtotal = corePlanTotal + addonsTotal + feesTotal;
    html += `<div class="d-flex justify-content-between border-top pt-2 mt-3">
        <strong>Subtotal</strong>
        <strong>$${subtotal.toFixed(2)}</strong>
    </div>`;

    // Apply discounts
    let totalDiscount = 0;
    if (selectedDiscounts.length > 0) {
        html += '<h6 class="border-bottom pb-2 mt-3">Discounts</h6>';

        selectedDiscounts.forEach(discount => {
            const label = document.querySelector(`label[for="discount_${discount.id}"]`).querySelector('strong').textContent;
            let discountAmount = 0;

            if (discount.appliesTo === 'core_plan') {
                if (discount.type === 'percentage') {
                    discountAmount = corePlanTotal * (discount.amount / 100);
                } else {
                    discountAmount = Math.min(discount.amount, corePlanTotal);
                }
            } else if (discount.appliesTo === 'add_ons') {
                if (discount.type === 'percentage') {
                    discountAmount = addonsTotal * (discount.amount / 100);
                } else {
                    discountAmount = Math.min(discount.amount, addonsTotal);
                }
            } else if (discount.appliesTo === 'fees') {
                if (discount.type === 'percentage') {
                    discountAmount = feesTotal * (discount.amount / 100);
                } else {
                    discountAmount = Math.min(discount.amount, feesTotal);
                }
            } else if (discount.appliesTo === 'total') {
                if (discount.type === 'percentage') {
                    discountAmount = subtotal * (discount.amount / 100);
                } else {
                    discountAmount = Math.min(discount.amount, subtotal);
                }
            }

            totalDiscount += discountAmount;
            html += `<div class="d-flex justify-content-between mb-2 text-danger">
                <small>${label}</small>
                <span>-$${discountAmount.toFixed(2)}</span>
            </div>`;
        });
    }

    // Grand Total
    const grandTotal = subtotal - totalDiscount;
    html += `<div class="d-flex justify-content-between border-top pt-3 mt-3">
        <h5 class="mb-0">Total ${selectedCorePlan.period === 'monthly' ? 'Monthly' : 'Weekly'}</h5>
        <h5 class="mb-0 text-success">$${grandTotal.toFixed(2)}</h5>
    </div>`;

    // Cost breakdown info
    if (selectedCorePlan.period === 'monthly') {
        html += `<div class="mt-3 p-2 bg-light rounded">
            <small class="text-muted">
                <strong>Weekly:</strong> ~$${(grandTotal / 4).toFixed(2)}<br>
                <strong>Annual:</strong> ~$${(grandTotal * 12).toFixed(2)}
            </small>
        </div>`;
    } else {
        html += `<div class="mt-3 p-2 bg-light rounded">
            <small class="text-muted">
                <strong>Monthly:</strong> ~$${(grandTotal * 4).toFixed(2)}<br>
                <strong>Annual:</strong> ~$${(grandTotal * 52).toFixed(2)}
            </small>
        </div>`;
    }

    // Save as Package button (only show if grand total is available)
    const monthlyTotal = selectedCorePlan.period === 'monthly' ? grandTotal : grandTotal * 4;
    html += `<div class="d-grid gap-2 mt-3">
        <button type="button" class="btn btn-primary" onclick="openSavePackageModal(${monthlyTotal})">
            <i class="bi bi-box-seam"></i> Save as Package
        </button>
    </div>`;

    html += '</div>';
    document.getElementById('summary-content').innerHTML = html;
}

// Open save package modal
function openSavePackageModal(monthlyTotal) {
    document.getElementById('package_monthly_tuition').value = monthlyTotal.toFixed(2);
    document.getElementById('package_core_plan_id').value = selectedCorePlan.id;

    // Clear extended care times (no longer used)
    document.getElementById('package_extended_start').value = '';
    document.getElementById('package_extended_end').value = '';

    // Prepare add-ons JSON
    document.getElementById('package_addons_json').value = JSON.stringify(selectedAddons);

    // Prepare fees JSON
    const feeIds = selectedFees.map(f => f.id);
    document.getElementById('package_fees_json').value = JSON.stringify(feeIds);

    // Prepare discounts JSON
    const discountIds = selectedDiscounts.map(d => d.id);
    document.getElementById('package_discounts_json').value = JSON.stringify(discountIds);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('savePackageModal'));
    modal.show();
}
</script>
{% endblock %}
